<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Detalle de Grupo - AddVenture</title>
    <!-- BLOQUE DE LINKS FRAGMENTS -->
    <th:block th:replace="~{fragments/head :: head-links}"></th:block>
    <!-- WebSocket global para notificaciones -->
    <th:block th:replace="~{fragments/head :: global-websocket}"></th:block>
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/detalle-grupo.css}">

    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
    <header th:replace="~{fragments/navbar :: navbar}"></header>

    <main class="container py-4 py-md-5">
        <!-- Breadcrumb -->
        <div class="mb-4">
            <a th:href="@{/grupos}" class="text-decoration-none text-primary">
                <i class="bi bi-arrow-left me-2"></i>Volver a resultados
            </a>
        </div>

        <!-- Group Detail Card -->
        <div class="card shadow-sm border-light mb-5">
            <!-- Hero Image -->
            <div class="position-relative">
                <div class="hero-image"
                    th:style="${grupo.viaje != null && grupo.viaje.imagenDestacada != null} ? 'background-image: url(' + ${grupo.viaje.imagenDestacada} + ');' : 'background-image: url(/images/default-trip.jpg);'">
                    <div class="overlay-gradient"></div>
                </div>
                <div class="position-absolute bottom-0 start-0 p-4 text-white">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge bg-primary" th:if="${grupo.viaje != null && grupo.viaje.tipo != null}"
                            th:text="${grupo.viaje.tipo.nombreTipo}">TIPO</span>
                        <span class="badge bg-success" th:if="${grupo.viaje != null && grupo.viaje.esVerificado}"><i
                                class="bi bi-check-circle me-1"></i>Verificado</span>
                    </div>
                    <h1 class="display-6 fw-bold mb-2" th:text="${grupo.nombreViaje}">Nombre del Viaje</h1>
                    <p class="fs-5 d-flex align-items-center"
                        th:if="${grupo.viaje != null && grupo.viaje.destinoPrincipal != null}">
                        <i class="bi bi-geo-alt me-1"></i> <span
                            th:text="${grupo.viaje.destinoPrincipal}">Destino</span>
                    </p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card-body p-4">
                <ul class="nav nav-tabs mb-4" id="groupTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="info-tab" data-bs-toggle="tab"
                            data-bs-target="#info-tab-pane" type="button" role="tab">
                            Informaci√≥n
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-tab-pane"
                            type="button" role="tab">
                            Chat del grupo <span class="d-none d-md-inline">(√önete primero)</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="groupTabsContent">
                    <!-- Info Tab -->
                    <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab"
                        tabindex="0">
                        <div class="row">
                            <!-- Main Content -->
                            <div class="col-md-8 mb-4 mb-md-0">
                                <!-- Description -->
                                <div class="mb-5">
                                    <h2 class="fs-3 fw-bold mb-3">Descripci√≥n</h2>
                                    <p class="text-secondary" th:if="${grupo.viaje != null}"
                                        th:text="${grupo.viaje.descripcion}">
                                        Descripci√≥n del viaje...
                                    </p>
                                </div>

                                <!-- Itinerary -->
                                <div class="mb-5" th:if="${grupo.itinerarios != null && !grupo.itinerarios.isEmpty()}">
                                    <h2 class="fs-3 fw-bold mb-3">Itinerario</h2>
                                    <div class="bg-light p-4 rounded">
                                        <ul class="list-unstyled mb-0">
                                            <li class="d-flex align-items-start mb-3"
                                                th:each="itinerario : ${grupo.itinerarios}">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 me-3"
                                                    style="width: 28px; height: 28px;"
                                                    th:text="${itinerario.diaNumero}">1</div>
                                                <span th:text="${itinerario.titulo}">D√≠a 1: T√≠tulo</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Members -->
                                <div>
                                    <h2 class="fs-3 fw-bold mb-3">Miembros del grupo</h2>
                                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">

                                        <!-- Organizador -->
                                        <div class="col">
                                            <div class="member-card text-center position-relative h-100">
                                                <div class="avatar-large bg-primary text-white mx-auto mb-2"
                                                    th:text="${#strings.substring(grupo.creador.nombreUsuario, 0, 2)}">
                                                    OR</div>
                                                <div class="fw-medium"
                                                    th:text="${grupo.creador.nombre + ' ' + grupo.creador.apellidos}">
                                                    Nombre Organizador</div>
                                                <div class="organizer-label">Organizador</div>
                                                <!-- Mostrar rol descriptivo del creador si existe -->
                                                <div th:if="${creadorRolDescriptivo != null && creadorRolDescriptivo != 'MIEMBRO'}" 
                                                     class="mt-1">
                                                    <span class="badge bg-warning text-dark small" 
                                                          th:text="${creadorRolDescriptivo == 'GU√çA' ? 'üó∫Ô∏è Gu√≠a' : 
                                                                    creadorRolDescriptivo == 'COORDINADOR' ? 'üìã Coordinador' : 
                                                                    creadorRolDescriptivo == 'TESORERO' ? 'üí∞ Tesorero' : 
                                                                    creadorRolDescriptivo == 'FOTOGRAFO' ? 'üì∏ Fot√≥grafo' : 
                                                                    creadorRolDescriptivo == 'COCINERO' ? 'üë®‚Äçüç≥ Chef' : 
                                                                    creadorRolDescriptivo == 'CONDUCTOR' ? 'üöó Conductor' : 
                                                                    creadorRolDescriptivo == 'NAVEGADOR' ? 'üß≠ Navegador' : 
                                                                    creadorRolDescriptivo == 'ANIMADOR' ? 'üéâ Animador' : 
                                                                    creadorRolDescriptivo == 'MEDICO' ? 'üè• Primeros auxilios' : 
                                                                    creadorRolDescriptivo == 'TRADUCTOR' ? 'üó£Ô∏è Traductor' : 
                                                                    creadorRolDescriptivo == 'LUGARE√ëO' ? 'üè† Conoce el lugar' : 
                                                                    creadorRolDescriptivo == 'PLANIFICADOR' ? 'üìÖ Planificador' : 
                                                                    creadorRolDescriptivo}">
                                                        üë§ Rol
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Solo participantes ACEPTADOS -->
                                        <div class="col" th:each="participante : ${participantesAceptadosList}"
                                            th:if="${participante.usuario.idUsuario != grupo.creador.idUsuario}">
                                            <div class="member-card text-center position-relative h-100">
                                                <div
                                                    class="avatar-large bg-secondary text-dark mx-auto mb-2 position-relative">
                                                    <span
                                                        th:text="${#strings.substring(participante.usuario.nombreUsuario, 0, 2)}">XX</span>
                                                    <span th:if="${participante.usuario.esVerificado}"
                                                        class="position-absolute top-0 end-0 translate-middle badge bg-success rounded-circle p-1">
                                                        <i class="bi bi-check-circle-fill fs-6"></i>
                                                    </span>
                                                </div>
                                                <div class="fw-medium"
                                                    th:text="${participante.usuario.nombre + ' ' + participante.usuario.apellidos}">
                                                    Nombre Participante</div>
                                                <!-- Mostrar rol descriptivo si existe -->
                                                <div th:if="${participante.rolParticipante != null && participante.rolParticipante != 'MIEMBRO'}" 
                                                     class="mt-1">
                                                    <span class="badge bg-info text-white small" 
                                                          th:text="${participante.rolParticipante == 'GU√çA' ? 'üó∫Ô∏è Gu√≠a' : 
                                                                    participante.rolParticipante == 'COORDINADOR' ? 'üìã Coordinador' : 
                                                                    participante.rolParticipante == 'TESORERO' ? 'üí∞ Tesorero' : 
                                                                    participante.rolParticipante == 'FOTOGRAFO' ? 'üì∏ Fot√≥grafo' : 
                                                                    participante.rolParticipante == 'COCINERO' ? 'üë®‚Äçüç≥ Chef' : 
                                                                    participante.rolParticipante == 'CONDUCTOR' ? 'üöó Conductor' : 
                                                                    participante.rolParticipante == 'NAVEGADOR' ? 'üß≠ Navegador' : 
                                                                    participante.rolParticipante == 'ANIMADOR' ? 'üéâ Animador' : 
                                                                    participante.rolParticipante == 'MEDICO' ? 'üè• Primeros auxilios' : 
                                                                    participante.rolParticipante == 'TRADUCTOR' ? 'üó£Ô∏è Traductor' : 
                                                                    participante.rolParticipante == 'LUGARE√ëO' ? 'üè† Conoce el lugar' : 
                                                                    participante.rolParticipante == 'PLANIFICADOR' ? 'üìÖ Planificador' : 
                                                                    participante.rolParticipante}">
                                                        üë§ Rol
                                                    </span>
                                                </div>

                                                <!-- Dropdown para gesti√≥n de miembros -->
                                                <div class="dropdown position-absolute top-0 end-0 me-2 mt-2"
                                                    th:if="${@permisos.puedeGestionar(grupo.idGrupo, participante.usuario.idUsuario)}">
                                                    <button class="btn btn-sm btn-light border-0" type="button"
                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-three-dots-vertical"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item"
                                                                th:href="@{/perfil/{id}(id=${participante.usuario.idUsuario})}">
                                                                <i class="bi bi-person me-2"></i>Ver perfil</a></li>
                                                        <li th:if="${@permisos.puedeAsignarRoles(grupo.idGrupo)}">
                                                            <a class="dropdown-item" href="#" data-bs-toggle="modal"
                                                                data-bs-target="#assignRoleModal"
                                                                th:data-user-id="${participante.usuario.idUsuario}"
                                                                th:data-user-name="${participante.usuario.nombre + ' ' + participante.usuario.apellidos}">
                                                                <i class="bi bi-person-gear me-2"></i>Asignar rol
                                                            </a>
                                                        </li>
                                                        <li th:if="${@permisos.puedeExpulsarMiembros(grupo.idGrupo)}">
                                                            <a class="dropdown-item text-danger" href="#"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#expelMemberModal"
                                                                th:data-user-id="${participante.usuario.idUsuario}"
                                                                th:data-user-name="${participante.usuario.nombre + ' ' + participante.usuario.apellidos}">
                                                                <i class="bi bi-x-circle me-2"></i>Expulsar del grupo
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sidebar -->
                            <div class="col-md-4">
                                <!-- Trip Details -->
                                <div class="card mb-4 border-light shadow-sm">
                                    <div class="card-body">
                                        <h3 class="fs-5 fw-bold mb-3">Detalles del viaje</h3>

                                        <div class="mb-3" th:if="${grupo.viaje != null}">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-calendar3 text-primary fs-5 me-3"></i>
                                                <div>
                                                    <p class="text-muted small mb-0">Fechas</p>
                                                    <p class="fw-medium mb-0">
                                                        <span
                                                            th:text="${#temporals.format(grupo.viaje.fechaInicio, 'dd MMM yyyy')}">Fecha
                                                            Inicio</span> -
                                                        <span
                                                            th:text="${#temporals.format(grupo.viaje.fechaFin, 'dd MMM yyyy')}">Fecha
                                                            Fin</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-people text-primary fs-5 me-3"></i>
                                                <div>
                                                    <p class="text-muted small mb-0">Participantes</p>
                                                    <p class="fw-medium mb-0">
                                                        <span th:text="${participantesAceptados} + 1">1</span> de <span
                                                            th:text="${grupo.maxParticipantes}"></span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3"
                                            th:if="${grupo.viaje != null && grupo.viaje.puntoEncuentro != null}">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-geo-alt text-primary fs-5 me-3"></i>
                                                <div>
                                                    <p class="text-muted small mb-0">Punto de encuentro</p>
                                                    <p class="fw-medium mb-0" th:text="${grupo.viaje.puntoEncuentro}">
                                                        Punto de encuentro</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Activities -->
                                <div class="card mb-4 border-light shadow-sm"
                                    th:if="${grupo.etiquetas != null && !grupo.etiquetas.isEmpty()}">
                                    <div class="card-body">
                                        <h3 class="fs-5 fw-bold mb-3">Actividades</h3>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-light text-dark border"
                                                th:each="etiqueta : ${grupo.etiquetas}"
                                                th:text="${etiqueta.nombreEtiqueta}">Etiqueta</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-3">
                                    <!-- Bot√≥n para unirse al grupo (si no tiene solicitud) -->
                                    <button id="joinGroupBtn" class="btn btn-primary"
                                        th:if="${#authentication.isAuthenticated() && !@permisos.esCreador(grupo.idGrupo) && estadoSolicitud == 'NINGUNA'}">
                                        <i class="bi bi-people me-2"></i> Unirse al grupo
                                    </button>

                                    <!-- Estado de solicitud pendiente -->
                                    <div class="alert alert-warning" 
                                         th:if="${#authentication.isAuthenticated() && estadoSolicitud == 'PENDIENTE'}">
                                        <i class="bi bi-clock me-2"></i> Solicitud enviada. Esperando aprobaci√≥n del l√≠der.
                                    </div>

                                    <!-- Estado de solicitud rechazada -->
                                    <div th:if="${#authentication.isAuthenticated() && estadoSolicitud == 'RECHAZADO'}">
                                        <div class="alert alert-danger">
                                            <i class="bi bi-x-circle me-2"></i> Tu solicitud fue rechazada.
                                        </div>
                                        <button id="retryJoinBtn" class="btn btn-outline-primary">
                                            <i class="bi bi-arrow-clockwise me-2"></i> Volver a solicitar
                                        </button>
                                    </div>

                                    <!-- Bot√≥n para abandonar el grupo (si es miembro aceptado pero no creador y grupo activo) -->
                                    <button id="leaveGroupBtn" class="btn btn-outline-danger"
                                        th:if="${#authentication.isAuthenticated() && !@permisos.esCreador(grupo.idGrupo) && @permisos.puedeAccederChat(grupo.idGrupo) && grupo.estado == 'activo'}"
                                        data-bs-toggle="modal" data-bs-target="#leaveGroupModal">
                                        <i class="bi bi-box-arrow-right me-2"></i> Abandonar grupo
                                    </button>

                                    <!-- Bot√≥n para editar grupo (si tiene permisos y grupo activo) -->
                                    <a th:href="@{/grupos/editar/{id}(id=${grupo.idGrupo})}" class="btn btn-outline-secondary"
                                       th:if="${#authentication.isAuthenticated() && @permisos.puedeEditarGrupo(grupo.idGrupo) && grupo.estado == 'activo'}">
                                        <i class="bi bi-pencil me-2"></i> Editar grupo
                                    </a>

                                    <!-- Bot√≥n para calificar viajeros (si es miembro y el viaje termin√≥) -->
                                    <a th:href="@{/calificaciones/grupo/{id}(id=${grupo.idGrupo})}" class="btn btn-outline-primary"
                                       th:if="${#authentication.isAuthenticated() && @permisos.puedeAccederChat(grupo.idGrupo) && grupo.estado == 'cerrado'}">
                                        <i class="bi bi-star me-2"></i> Calificar viajeros
                                    </a>

                                    <!-- Bot√≥n para cerrar viaje (si tiene permisos) -->
                                    <button id="closeGroupBtn" class="btn btn-outline-warning"
                                        th:if="${#authentication.isAuthenticated() && @permisos.tienePermiso(grupo.idGrupo, 'CERRAR_GRUPO') && grupo.estado == 'activo'}">
                                        <i class="bi bi-lock me-2"></i> Cerrar viaje
                                    </button>

                                    <!-- Bot√≥n para eliminar grupo (si tiene permisos) -->
                                    <button id="deleteGroupBtn" class="btn btn-outline-danger"
                                        th:if="${#authentication.isAuthenticated() && @permisos.puedeEliminarGrupo(grupo.idGrupo)}"
                                        data-bs-toggle="modal" data-bs-target="#deleteGroupModal">
                                        <i class="bi bi-trash me-2"></i> Eliminar grupo
                                    </button>

                                                        <!-- Ver galer√≠a de fotos (si el viaje est√° cerrado/concluido y fue participante) -->
                    <a th:href="@{/grupos/{id}/galeria-fotos(id=${grupo.idGrupo})}" class="btn btn-outline-info"
                       th:if="${#authentication.isAuthenticated() && @permisos.puedeAccederChat(grupo.idGrupo) && (grupo.estado == 'cerrado' || grupo.estado == 'concluido')}">
                        <i class="bi bi-images me-2"></i> Ver galer√≠a de fotos
                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Tab -->
                    <div class="tab-pane fade" id="chat-tab-pane" role="tabpanel" aria-labelledby="chat-tab"
                        tabindex="0">
                        <div class="alert alert-primary d-flex align-items-center mb-4" role="alert">
                            <i class="bi bi-info-circle me-2 fs-5"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Foro del grupo</h5>
                                <p class="mb-0">Este es un espacio para que los miembros del grupo coordinen detalles
                                    del viaje, hagan preguntas y se conozcan mejor antes de la aventura.</p>
                            </div>
                        </div>

                        <div class="card border-light shadow-sm">
                            <div
                                class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chat-square-text me-2"></i>
                                    <h5 class="mb-0">Chat de grupo: <span th:text="${grupo.nombreViaje}">Nombre del
                                            Grupo</span></h5>
                                </div>
                                <span class="badge bg-white text-primary">
                                    <span th:text="${participantesAceptados + 1}">1</span>
                                    participantes
                                </span>
                            </div>

                                        <div class="card-body p-0" style="height: 500px; display: flex; flex-direction: column;">
                <div class="chat-container p-3 flex-grow-1" id="chatMessages" style="overflow-y: auto; max-height: 100%;">
                    <!-- Mensajes del chat (se cargar√≠an din√°micamente) -->
                    <div class="alert alert-info text-center" th:if="${!@permisos.puedeAccederChat(grupo.idGrupo)}">
                        <i class="bi bi-lock me-2"></i>
                        Debes unirte al grupo para acceder al chat
                    </div>
                </div>

                                                <!-- Chat Input -->
                <div class="p-3 border-top bg-white" th:if="${@permisos.puedeEnviarMensajes(grupo.idGrupo)}" style="flex-shrink: 0;">
                    <div class="input-group mb-2">
                        <input type="text" id="chatInput" class="form-control"
                            placeholder="Escribe un mensaje...">
                        <button id="sendBtn" class="btn btn-primary" type="button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    <div class="d-flex align-items-center">
                        <input type="file" id="imageInput" class="form-control" accept="image/*" style="display: none;">
                        <button id="imageBtn" class="btn btn-outline-secondary btn-sm me-2" type="button">
                            <i class="bi bi-image"></i> Enviar imagen
                        </button>
                        <small class="text-muted">Env√≠a mensajes y fotos del viaje</small>
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Expel Member Modal -->
    <div class="modal fade" id="expelMemberModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Expulsar miembro
                        del grupo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Est√°s a punto de expulsar a <strong id="expelMemberName">Nombre del miembro</strong> del grupo.
                        Esta acci√≥n no se puede
                        deshacer.</p>

                    <div class="alert alert-warning d-flex align-items-start mb-3">
                        <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                        <span>La expulsi√≥n de un miembro debe estar justificada. El usuario ser√° notificado del motivo
                            de su expulsi√≥n.</span>
                    </div>

                    <form id="expelMemberForm" th:action="@{/grupos/{id}/expulsar(id=${grupo.idGrupo})}" method="post">
                        <input type="hidden" id="expelMemberId" name="userId" value="">

                        <div class="mb-3">
                            <h6 class="fw-bold">Motivo de la expulsi√≥n</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="expulsionReason" id="reason1"
                                    value="comportamiento_inapropiado" required>
                                <label class="form-check-label" for="reason1">Comportamiento inapropiado</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="expulsionReason" id="reason2"
                                    value="incumplimiento_normas">
                                <label class="form-check-label" for="reason2">Incumplimiento de normas del grupo</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="expulsionReason" id="reason3"
                                    value="inactividad">
                                <label class="form-check-label" for="reason3">Inactividad prolongada</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="expulsionReason" id="reason4"
                                    value="solicitud_propia">
                                <label class="form-check-label" for="reason4">Solicitud del propio miembro</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="expulsionReason" id="reason5"
                                    value="otro">
                                <label class="form-check-label" for="reason5">Otro motivo</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="expulsionComment" class="form-label">Comentarios adicionales (opcional)</label>
                            <textarea class="form-control" id="expulsionComment" name="expulsionComment" rows="3"
                                placeholder="A√±ade detalles sobre el motivo de la expulsi√≥n..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmExpelBtn">
                        <i class="bi bi-person-x me-2"></i>Expulsar miembro
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Group Modal -->
    <div class="modal fade" id="leaveGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Salir del grupo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Est√°s a punto de abandonar el grupo <strong th:text="${grupo.nombreViaje}">Nombre del
                            Grupo</strong>. ¬øEst√°s seguro?</p>

                    <div class="alert alert-warning d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                        <span>Al salir del grupo perder√°s acceso al chat y a la informaci√≥n de contacto de los dem√°s
                            miembros. Si deseas volver a unirte, deber√°s solicitar acceso nuevamente.</span>
                    </div>

                    <form id="leaveGroupForm" th:action="@{/grupos/{id}/abandonar(id=${grupo.idGrupo})}" method="post">
                        <!-- No additional fields needed -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmLeaveBtn">
                        <i class="bi bi-box-arrow-right me-2"></i>Salir del grupo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Group Confirmation Modal -->
    <div class="modal fade" id="joinGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-success">
                <div class="modal-header">
                    <h5 class="modal-title text-success"><i class="bi bi-check-circle me-2"></i>Te has unido al grupo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>Ahora eres parte del grupo <strong th:text="${grupo.nombreViaje}">Nombre del Grupo</strong>.
                        ¬°Disfruta tu viaje!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Group Modal -->
    <div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>Eliminar grupo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Est√°s a punto de eliminar el grupo <strong th:text="${grupo.nombreViaje}">Nombre del Grupo</strong>.</p>
                    
                    <div class="alert alert-danger d-flex align-items-start mb-3">
                        <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                        <div>
                            <strong>¬°Atenci√≥n!</strong> Esta acci√≥n no se puede deshacer.
                            <ul class="mb-0 mt-2">
                                <li>Se eliminar√° toda la informaci√≥n del grupo</li>
                                <li>Se perder√° el historial del chat</li>
                                <li>Los participantes ser√°n notificados</li>
                            </ul>
                        </div>
                    </div>

                    <div id="deleteGroupInfo" class="alert alert-info d-none">
                        <!-- Informaci√≥n sobre las reglas de eliminaci√≥n -->
                    </div>

                    <div class="mb-3">
                        <label for="deleteConfirmText" class="form-label">
                            Para confirmar, escribe "<strong>ELIMINAR</strong>" en el siguiente campo:
                        </label>
                        <input type="text" class="form-control" id="deleteConfirmText" 
                               placeholder="Escribe ELIMINAR">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                        <i class="bi bi-trash me-2"></i>Eliminar grupo permanentemente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Role Modal -->
    <div class="modal fade" id="assignRoleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary">
                        <i class="bi bi-person-gear me-2"></i>Asignar rol en el viaje
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Asignar un rol descriptivo a <strong id="roleAssignMemberName">Nombre del miembro</strong></p>
                    
                    <div class="alert alert-info d-flex align-items-start mb-3">
                        <i class="bi bi-info-circle me-2 mt-1"></i>
                        <span>Los roles son solo descriptivos para organizar mejor el viaje. No afectan los permisos del sistema.</span>
                    </div>

                    <form id="assignRoleForm" th:action="@{/grupos/{id}/asignar-rol(id=${grupo.idGrupo})}" method="post">
                        <input type="hidden" id="roleAssignUserId" name="userId" value="">

                        <div class="mb-3">
                            <label for="roleSelect" class="form-label fw-bold">Seleccionar rol</label>
                            <select class="form-select" id="roleSelect" name="rolDescriptivo" required>
                                <option value="">-- Seleccionar rol --</option>
                                <optgroup label="Roles de organizaci√≥n">
                                    <option value="GU√çA">üó∫Ô∏è Gu√≠a del viaje</option>
                                    <option value="COORDINADOR">üìã Coordinador</option>
                                    <option value="TESORERO">üí∞ Tesorero/Finanzas</option>
                                    <option value="FOTOGRAFO">üì∏ Fot√≥grafo oficial</option>
                                </optgroup>
                                <optgroup label="Roles de actividades">
                                    <option value="COCINERO">üë®‚Äçüç≥ Cocinero/Chef</option>
                                    <option value="CONDUCTOR">üöó Conductor</option>
                                    <option value="NAVEGADOR">üß≠ Navegador</option>
                                    <option value="ANIMADOR">üéâ Animador</option>
                                </optgroup>
                                <optgroup label="Roles especiales">
                                    <option value="MEDICO">üè• Encargado de primeros auxilios</option>
                                    <option value="TRADUCTOR">üó£Ô∏è Traductor</option>
                                    <option value="LUGARE√ëO">üè† Conoce el lugar</option>
                                    <option value="PLANIFICADOR">üìÖ Planificador de actividades</option>
                                </optgroup>
                                <optgroup label="Sin rol espec√≠fico">
                                    <option value="MIEMBRO">üë§ Miembro (sin rol espec√≠fico)</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="roleNotes" class="form-label">Notas adicionales (opcional)</label>
                            <textarea class="form-control" id="roleNotes" name="notasRol" rows="2"
                                placeholder="A√±ade informaci√≥n adicional sobre el rol o responsabilidades..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmAssignRoleBtn">
                        <i class="bi bi-check-lg me-2"></i>Asignar rol
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- WebSocket libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Script para la p√°gina de detalle de grupo -->
    <script th:inline="javascript">
        const grupoId = /*[[${grupo.idGrupo}]]*/ 0;
        const isParticipante = /*[[${isParticipante}]]*/ false;

        document.addEventListener('DOMContentLoaded', function () {
            // Bot√≥n para unirse al grupo
            const joinGroupBtn = document.getElementById('joinGroupBtn');
            if (joinGroupBtn) {
                joinGroupBtn.addEventListener('click', function () {
                    // Enviar solicitud para unirse al grupo
                    fetch(`/grupos/${grupoId}/unirse`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                mostrarMensajeExito(data.message || 'Solicitud enviada exitosamente');
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                mostrarMensajeError(data.error || 'Error al enviar solicitud');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            mostrarMensajeError('Error al unirse al grupo. Int√©ntalo de nuevo.');
                        });
                });
            }

            // Bot√≥n para volver a solicitar (despu√©s de rechazo)
            const retryJoinBtn = document.getElementById('retryJoinBtn');
            if (retryJoinBtn) {
                retryJoinBtn.addEventListener('click', function () {
                    mostrarConfirmacion('¬øEst√°s seguro de que quieres volver a solicitar unirte a este grupo?', (confirmado) => {
                        if (confirmado) {
                            // Enviar solicitud para unirse al grupo
                            fetch(`/grupos/${grupoId}/unirse`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        mostrarMensajeExito(data.message || 'Nueva solicitud enviada exitosamente');
                                        setTimeout(() => location.reload(), 1500);
                                    } else {
                                        mostrarMensajeError(data.error || 'Error al enviar solicitud');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    mostrarMensajeError('Error al enviar solicitud. Int√©ntalo de nuevo.');
                                });
                        }
                    });
                });
            }

            // Funcionalidad del chat
            if (isParticipante) {
                initChat();
            }

            // Bot√≥n cerrar viaje
            const closeGroupBtn = document.getElementById('closeGroupBtn');
            if (closeGroupBtn) {
                closeGroupBtn.addEventListener('click', function() {
                    mostrarConfirmacion('¬øEst√°s seguro de que quieres cerrar este viaje? Esta acci√≥n no se puede deshacer y habilitar√° las calificaciones.', (confirmado) => {
                        if (confirmado) {
                            fetch(`/chat/grupo/${grupoId}/cerrar`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            })
                            .then(response => response.text())
                            .then(data => {
                                if (data.includes('√©xito') || data.includes('cerrado')) {
                                    mostrarMensajeExito('Viaje cerrado exitosamente');
                                    setTimeout(() => location.reload(), 1500);
                                } else {
                                    mostrarMensajeError('Error al cerrar el viaje: ' + data);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                mostrarMensajeError('Error al cerrar el viaje');
                            });
                        }
                    });
                });
            }

            // Manejo de modales
            setupModals();
        });

        function initChat() {
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const imageBtn = document.getElementById('imageBtn');
            const imageInput = document.getElementById('imageInput');

            // Cargar mensajes al iniciar
            loadMessages();
            
            // Configurar WebSocket para chat en tiempo real
            setupWebSocketChat();

            // Enviar mensaje de texto
            function sendMessage() {
                const mensaje = chatInput.value.trim();
                if (!mensaje) return;

                const formData = new FormData();
                formData.append('mensaje', mensaje);

                fetch(`/chat/grupo/${grupoId}/enviar`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Error del servidor');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.idMensaje) {
                        chatInput.value = '';
                        // No necesitamos recargar todos los mensajes, WebSocket se encarga
                    } else {
                        mostrarMensajeError('No se pudo enviar el mensaje');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarMensajeError(error.message || 'Error al enviar mensaje');
                });
            }

            // Eventos
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Bot√≥n de imagen
            imageBtn.addEventListener('click', function() {
                imageInput.click();
            });

            // Enviar imagen
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    mostrarMensajeError('Solo se permiten archivos de imagen');
                    imageInput.value = '';
                    return;
                }

                // Validar tama√±o (m√°ximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    mostrarMensajeError('La imagen es demasiado grande. M√°ximo 5MB');
                    imageInput.value = '';
                    return;
                }

                const formData = new FormData();
                formData.append('imagen', file);
                formData.append('descripcion', '');

                // Obtener token CSRF
                const token = document.querySelector('meta[name="_csrf"]').content;
                const header = document.querySelector('meta[name="_csrf_header"]').content;

                fetch(`/chat/grupo/${grupoId}/enviar-imagen`, {
                    method: 'POST',
                    headers: {
                        [header]: token
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Error del servidor');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.idMensaje) {
                        imageInput.value = '';
                        // No necesitamos recargar todos los mensajes, WebSocket se encarga
                    } else {
                        mostrarMensajeError('No se pudo enviar la imagen');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarMensajeError(error.message || 'Error al enviar imagen');
                });
            });

            // Configurar WebSocket para mensajes en tiempo real
            function setupWebSocketChat() {
                const socket = new SockJS('/ws');
                const stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    
                    // Suscribirse al canal del grupo para recibir mensajes en tiempo real
                    stompClient.subscribe('/topic/grupo/' + grupoId, function (message) {
                        const nuevoMensaje = JSON.parse(message.body);
                        appendMessage(nuevoMensaje);
                    });
                    
                    // Suscribirse al canal de eliminaci√≥n de mensajes
                    stompClient.subscribe('/topic/grupo/' + grupoId + '/delete', function (message) {
                        const idMensajeEliminado = JSON.parse(message.body);
                        removeMessage(idMensajeEliminado);
                    });
                }, function (error) {
                    console.log('WebSocket connection error: ' + error);
                    // Sin fallback autom√°tico para evitar actualizaciones molestas
                    console.log('Chat funcionar√° solo con WebSocket cuando se reconecte');
                });
            }
            
            // Funci√≥n para agregar un solo mensaje al chat
            function appendMessage(mensaje) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                const currentUserId = /*[[${usuarioId}]]*/ null;
                const isCurrentUser = mensaje.remitente && mensaje.remitente.idUsuario === currentUserId;

                messageDiv.setAttribute('data-message-id', mensaje.idMensaje);

                if (isCurrentUser) {
                    // Mensaje del usuario actual (derecha)
                    messageDiv.className = 'mb-3 d-flex justify-content-end';
                    messageDiv.innerHTML = `
                        <div class="d-flex align-items-start flex-row-reverse" style="max-width: 70%;">
                            <div class="ms-3">
                                <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center">
                                    ${mensaje.remitente.nombre.charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1 justify-content-end">
                                    <button class="btn btn-sm btn-outline-danger me-2 delete-message-btn" 
                                            data-message-id="${mensaje.idMensaje}" 
                                            title="Eliminar mensaje">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <small class="text-muted me-2">${formatDate(mensaje.fechaEnvio)}</small>
                                    <strong>T√∫</strong>
                                </div>
                                <div class="message-content bg-primary text-white p-3 rounded-3">
                                    ${mensaje.tipoMensaje === 'imagen' ? 
                                        `<img src="${mensaje.archivoUrl}" class="img-fluid rounded mb-2" style="max-width: 250px;">
                                         ${mensaje.mensaje !== 'Imagen compartida' ? `<p class="mb-0">${mensaje.mensaje}</p>` : ''}` : 
                                        `<p class="mb-0">${mensaje.mensaje}</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Mensaje de otros usuarios (izquierda)
                    messageDiv.className = 'mb-3 d-flex align-items-start';
                    messageDiv.innerHTML = `
                        <div class="me-3">
                            <div class="avatar-sm bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center">
                                ${mensaje.remitente ? mensaje.remitente.nombre.charAt(0).toUpperCase() : 'U'}
                            </div>
                        </div>
                        <div class="flex-grow-1" style="max-width: 70%;">
                            <div class="d-flex align-items-center mb-1">
                                <strong class="me-2">${mensaje.remitente ? mensaje.remitente.nombre + ' ' + mensaje.remitente.apellidos : 'Usuario'}</strong>
                                <small class="text-muted">${formatDate(mensaje.fechaEnvio)}</small>
                            </div>
                            <div class="message-content bg-light p-3 rounded-3">
                                ${mensaje.tipoMensaje === 'imagen' ? 
                                    `<img src="${mensaje.archivoUrl}" class="img-fluid rounded mb-2" style="max-width: 250px;">
                                     ${mensaje.mensaje !== 'Imagen compartida' ? `<p class="mb-0">${mensaje.mensaje}</p>` : ''}` : 
                                    `<p class="mb-0">${mensaje.mensaje}</p>`}
                            </div>
                        </div>
                    `;
                }

                chatMessages.appendChild(messageDiv);
                setupDeleteButtons(); // Configurar eventos de eliminar
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function loadMessages() {
            fetch(`/chat/grupo/${grupoId}/mensajes`)
                .then(response => response.json())
                .then(mensajes => {
                    displayMessages(mensajes);
                })
                .catch(error => {
                    console.error('Error al cargar mensajes:', error);
                });
        }

        function displayMessages(mensajes) {
            const chatMessages = document.getElementById('chatMessages');
            if (!Array.isArray(mensajes)) return;

            chatMessages.innerHTML = '';
            
            const currentUserId = /*[[${usuarioId}]]*/ null;
            
            mensajes.forEach(mensaje => {
                const messageDiv = document.createElement('div');
                const isCurrentUser = mensaje.remitente && mensaje.remitente.idUsuario === currentUserId;

                messageDiv.setAttribute('data-message-id', mensaje.idMensaje);

                if (isCurrentUser) {
                    // Mensaje del usuario actual (derecha)
                    messageDiv.className = 'mb-3 d-flex justify-content-end';
                    messageDiv.innerHTML = `
                        <div class="d-flex align-items-start flex-row-reverse" style="max-width: 70%;">
                            <div class="ms-3">
                                <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center">
                                    ${mensaje.remitente.nombre.charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1 justify-content-end">
                                    <button class="btn btn-sm btn-outline-danger me-2 delete-message-btn" 
                                            data-message-id="${mensaje.idMensaje}" 
                                            title="Eliminar mensaje">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <small class="text-muted me-2">${formatDate(mensaje.fechaEnvio)}</small>
                                    <strong>T√∫</strong>
                                </div>
                                <div class="message-content bg-primary text-white p-3 rounded-3">
                                    ${mensaje.tipoMensaje === 'imagen' ? 
                                        `<img src="${mensaje.archivoUrl}" class="img-fluid rounded mb-2" style="max-width: 250px;">
                                         ${mensaje.mensaje !== 'Imagen compartida' ? `<p class="mb-0">${mensaje.mensaje}</p>` : ''}` : 
                                        `<p class="mb-0">${mensaje.mensaje}</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Mensaje de otros usuarios (izquierda)
                    messageDiv.className = 'mb-3 d-flex align-items-start';
                    messageDiv.innerHTML = `
                        <div class="me-3">
                            <div class="avatar-sm bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center">
                                ${mensaje.remitente ? mensaje.remitente.nombre.charAt(0).toUpperCase() : 'U'}
                            </div>
                        </div>
                        <div class="flex-grow-1" style="max-width: 70%;">
                            <div class="d-flex align-items-center mb-1">
                                <strong class="me-2">${mensaje.remitente ? mensaje.remitente.nombre + ' ' + mensaje.remitente.apellidos : 'Usuario'}</strong>
                                <small class="text-muted">${formatDate(mensaje.fechaEnvio)}</small>
                            </div>
                            <div class="message-content bg-light p-3 rounded-3">
                                ${mensaje.tipoMensaje === 'imagen' ? 
                                    `<img src="${mensaje.archivoUrl}" class="img-fluid rounded mb-2" style="max-width: 250px;">
                                     ${mensaje.mensaje !== 'Imagen compartida' ? `<p class="mb-0">${mensaje.mensaje}</p>` : ''}` : 
                                    `<p class="mb-0">${mensaje.mensaje}</p>`}
                            </div>
                        </div>
                    `;
                }

                chatMessages.appendChild(messageDiv);
            });

            // Configurar eventos de eliminar despu√©s de cargar todos los mensajes
            setupDeleteButtons();
            
            // Scroll al final
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
            });
        }

        // Funci√≥n para configurar los eventos de eliminar mensaje
        function setupDeleteButtons() {
            document.querySelectorAll('.delete-message-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    if (confirm('¬øEst√°s seguro de que quieres eliminar este mensaje?')) {
                        deleteMessage(messageId);
                    }
                });
            });
        }

        // Funci√≥n para eliminar un mensaje
        function deleteMessage(messageId) {
            fetch(`/chat/grupo/${grupoId}/eliminar-mensaje/${messageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.text())
            .then(data => {
                if (data.includes('exitosamente')) {
                    // El mensaje se eliminar√° autom√°ticamente via WebSocket
                    console.log('Mensaje eliminado exitosamente');
                } else {
                    alert('Error al eliminar mensaje: ' + data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar mensaje');
            });
        }

        // Funci√≥n para remover un mensaje del DOM cuando se elimina via WebSocket
        function removeMessage(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                messageDiv.remove();
            }
        }

        // Funci√≥n para mostrar mensajes de error elegantes
        function mostrarMensajeError(mensaje) {
            // Buscar si ya existe un mensaje de error para no duplicar
            const existingAlert = document.querySelector('.chat-error-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // Crear el alert elegante
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show chat-error-alert';
            alertDiv.style.cssText = 'margin: 10px 0; border-radius: 8px;';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>
                        <strong>üí¨ AddVenture:</strong> ${mensaje}
                    </div>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Insertar el mensaje arriba del √°rea de chat
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.parentElement.insertBefore(alertDiv, chatMessages);

            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function setupModals() {
            // Manejo del modal de expulsi√≥n
            const expelMemberModal = document.getElementById('expelMemberModal');
            if (expelMemberModal) {
                expelMemberModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const userId = button.getAttribute('data-user-id');
                    const userName = button.getAttribute('data-user-name');

                    document.getElementById('expelMemberId').value = userId;
                    document.getElementById('expelMemberName').textContent = userName;
                });

                // Bot√≥n para confirmar expulsi√≥n
                document.getElementById('confirmExpelBtn').addEventListener('click', function () {
                    document.getElementById('expelMemberForm').submit();
                });
            }

            // Bot√≥n para confirmar salida del grupo
            const confirmLeaveBtn = document.getElementById('confirmLeaveBtn');
            if (confirmLeaveBtn) {
                confirmLeaveBtn.addEventListener('click', function () {
                    document.getElementById('leaveGroupForm').submit();
                });
            }

            // Manejo del modal de asignaci√≥n de rol
            const assignRoleModal = document.getElementById('assignRoleModal');
            if (assignRoleModal) {
                assignRoleModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const userId = button.getAttribute('data-user-id');
                    const userName = button.getAttribute('data-user-name');

                    document.getElementById('roleAssignUserId').value = userId;
                    document.getElementById('roleAssignMemberName').textContent = userName;
                    
                    // Limpiar formulario
                    document.getElementById('roleSelect').value = '';
                    document.getElementById('roleNotes').value = '';
                });

                // Bot√≥n para confirmar asignaci√≥n de rol
                document.getElementById('confirmAssignRoleBtn').addEventListener('click', function () {
                    const roleSelect = document.getElementById('roleSelect');
                    if (!roleSelect.value) {
                        mostrarMensajeError('Por favor selecciona un rol');
                        return;
                    }
                    document.getElementById('assignRoleForm').submit();
                });
            }

            // Manejo del modal de eliminar grupo
            const deleteGroupModal = document.getElementById('deleteGroupModal');
            const deleteConfirmText = document.getElementById('deleteConfirmText');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            
            if (deleteGroupModal && deleteConfirmText && confirmDeleteBtn) {
                // Validar texto de confirmaci√≥n
                deleteConfirmText.addEventListener('input', function() {
                    const isValid = this.value.trim().toUpperCase() === 'ELIMINAR';
                    confirmDeleteBtn.disabled = !isValid;
                    
                    if (isValid) {
                        confirmDeleteBtn.classList.remove('btn-danger');
                        confirmDeleteBtn.classList.add('btn-danger');
                    }
                });

                // Limpiar modal al cerrarse
                deleteGroupModal.addEventListener('hidden.bs.modal', function() {
                    deleteConfirmText.value = '';
                    confirmDeleteBtn.disabled = true;
                    document.getElementById('deleteGroupInfo').classList.add('d-none');
                });

                // Confirmar eliminaci√≥n
                confirmDeleteBtn.addEventListener('click', function() {
                    if (deleteConfirmText.value.trim().toUpperCase() !== 'ELIMINAR') {
                        mostrarMensajeError('Debes escribir "ELIMINAR" para confirmar');
                        return;
                    }

                    // Deshabilitar bot√≥n y mostrar loading
                    confirmDeleteBtn.disabled = true;
                    confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';

                    // Realizar petici√≥n de eliminaci√≥n
                    fetch(`/grupos/${grupoId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // √âxito - redirigir
                            mostrarMensajeExito(data.mensaje || 'Grupo eliminado exitosamente');
                            setTimeout(() => window.location.href = '/grupos/mis-viajes', 1500);
                        } else if (data.requiereVotacion) {
                            // Requiere votaci√≥n
                            showVotationInfo(data);
                        } else {
                            // Error
                            mostrarMensajeError(data.error || 'Error al eliminar el grupo');
                            resetDeleteButton();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarMensajeError('Error de conexi√≥n al eliminar el grupo');
                        resetDeleteButton();
                    });
                });

                function resetDeleteButton() {
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.innerHTML = '<i class="bi bi-trash me-2"></i>Eliminar grupo permanentemente';
                }

                function showVotationInfo(data) {
                    const infoDiv = document.getElementById('deleteGroupInfo');
                    infoDiv.className = 'alert alert-warning';
                    infoDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                            <div>
                                <strong>Se requiere votaci√≥n para eliminar el grupo</strong>
                                <p class="mb-2 mt-2">${data.razon}</p>
                                <ul class="mb-2">
                                    <li>Participantes en el grupo: ${data.totalParticipantes}</li>
                                    <li>Votos necesarios (70%): ${Math.ceil(data.votosMinimosnecesarios)}</li>
                                </ul>
                                <p class="mb-0"><strong>Pr√≥ximamente:</strong> ${data.solucion}</p>
                            </div>
                        </div>
                    `;
                    infoDiv.classList.remove('d-none');
                    resetDeleteButton();
                }
            }
        }

        // Funciones para mensajes elegantes
        function mostrarMensajeExito(mensaje) {
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" 
                     role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                        <div>
                            <strong>‚úÖ AddVenture:</strong> ${mensaje}
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(alertContainer);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alertContainer.remove(), 300);
                }
            }, 5000);
        }

        function mostrarMensajeError(mensaje) {
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" 
                     role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                        <div>
                            <strong>‚ùå AddVenture:</strong> ${mensaje}
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(alertContainer);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alertContainer.remove(), 300);
                }
            }, 5000);
        }

        function mostrarConfirmacion(mensaje, callback) {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div class="modal fade" tabindex="-1" style="z-index: 9999;">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="bi bi-question-circle me-2"></i>
                                    Confirmaci√≥n
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-exclamation-triangle text-warning me-3 fs-3"></i>
                                    <div>
                                        <p class="mb-0">${mensaje}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x me-1"></i> Cancelar
                                </button>
                                <button type="button" class="btn btn-warning" id="confirmBtn">
                                    <i class="bi bi-check me-1"></i> Confirmar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const bootstrapModal = new bootstrap.Modal(modal.querySelector('.modal'));
            bootstrapModal.show();
            
            // Manejar confirmaci√≥n
            modal.querySelector('#confirmBtn').addEventListener('click', () => {
                bootstrapModal.hide();
                callback(true);
            });
            
            // Limpiar al cerrar
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // CSS adicional para avatares y chat
        const additionalCSS = `
            .avatar-sm {
                width: 35px;
                height: 35px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
            }
            
            .message-content {
                word-wrap: break-word;
                max-width: 100%;
            }
            
            .message-content img {
                border-radius: 8px;
                cursor: pointer;
                transition: transform 0.2s;
            }
            
            .message-content img:hover {
                transform: scale(1.05);
            }
            
            .chat-container {
                background: #f8f9fa;
                border-radius: 8px 8px 0 0;
            }
            
            .message-content.bg-primary {
                background: linear-gradient(135deg, #007bff, #0056b3) !important;
                border-radius: 18px 18px 4px 18px !important;
                box-shadow: 0 2px 8px rgba(0,123,255,0.2);
            }
            
            .message-content.bg-light {
                background: #ffffff !important;
                border: 1px solid #e9ecef;
                border-radius: 18px 18px 18px 4px !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .delete-message-btn {
                opacity: 0;
                transition: opacity 0.2s;
                border: none !important;
                background: rgba(220, 53, 69, 0.1) !important;
                color: #dc3545 !important;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .delete-message-btn:hover {
                background: rgba(220, 53, 69, 0.2) !important;
                color: #dc3545 !important;
            }
            
            .mb-3:hover .delete-message-btn {
                opacity: 1;
            }
            
            /* Mejorar el scrollbar del chat */
            .chat-container::-webkit-scrollbar {
                width: 6px;
            }
            
            .chat-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }
            
            .chat-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 3px;
            }
            
            .chat-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
        `;
        const styleSheet = document.createElement('style');
        styleSheet.type = 'text/css';
        styleSheet.innerText = additionalCSS;
        document.head.appendChild(styleSheet);
    </script>


</body>

</html>