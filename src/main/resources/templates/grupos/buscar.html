<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Grupos de Viaje | AddVenture</title>
    <!-- BLOQUE DE LINKS FRAGMENTS -->
    <th:block th:replace="~{fragments/head :: head-links}"></th:block>

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/buscar-grupos.css}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
    <header th:replace="~{fragments/navbar :: navbar}"></header>
    <main class="bg-light py-4 py-md-5">
        <div class="container">
            <!-- Hero para crear nuevo grupo -->
            <div class="card mb-4 border-0 rounded-4 overflow-hidden shadow-lg">
                <div class="position-relative">
                    <div class="overlay-gradient"></div>
                    <img th:src="@{/images/aventurero.jpg}" alt="Grupo de viajeros"
                        class="img-cover card-img w-100 object-cover" style="height: 300px;">

                    <div class="card-img-overlay d-flex flex-column justify-content-center text-white p-4 p-md-5">
                        <h1 class="display-5 fw-bold mb-3">¿No encuentras el grupo perfecto para ti?</h1>
                        <p class="lead mb-4 text-light">Crea tu propio grupo de viaje, define el destino, las fechas y
                            encuentra compañeros con tus mismos intereses.</p>
                        <div>
                            <a th:href="@{/crear-grupo}" class="btn btn-light btn-lg text-primary">
                                <i class="bi bi-plus-circle me-2"></i>Crear nuevo grupo
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensaje de éxito -->
            <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${mensaje}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <h2 class="fw-bold mb-4">Buscar Grupos de Viaje</h2>

            <!-- Filtros unificados -->
            <div class="card mb-4 border-light shadow-sm">
                <div class="card-body p-4">
                    <ul class="nav nav-tabs mb-4" id="searchTabs" role="tablist">
                        <li class="nav-item flex-fill text-center" role="presentation">
                            <button class="nav-link active w-100" id="quick-search-tab" data-bs-toggle="tab"
                                data-bs-target="#quick-search" type="button" role="tab">Búsqueda rápida</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="searchTabsContent">
                        <!-- Búsqueda rápida -->
                        <div class="tab-pane fade show active" id="quick-search" role="tabpanel">
                            <form th:action="@{/grupos}" method="get">
                                <div class="row g-3 mb-4">
                                    <div class="col-md-3">
                                        <label for="destino" class="form-label">¿A dónde quieres ir?</label>
                                        <input type="text" class="form-control form-control-lg" id="destino"
                                            name="destinoPrincipal" placeholder="Ej: Piura">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="fechaInicio" class="form-label">Fecha de inicio</label>
                                        <input type="date" class="form-control form-control-lg" id="fechaInicio"
                                            name="fechaInicio" th:attr="min=${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="fechaFin" class="form-label">Fecha de fin</label>
                                        <input type="date" class="form-control form-control-lg" id="fechaFin"
                                            name="fechaFin" th:attr="min=${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="ordenar" class="form-label">Ordenar</label>
                                        <select name="sort" id="ordenar" class="form-select form-select-lg" onchange="this.form.submit()">
                                            <option value="">Seleccionar</option>
                                            <option value="destinoPrincipal" th:selected="${sort == 'destinoPrincipal'}">
                                                Destino</option>
                                            <option value="fechaInicio" th:selected="${sort == 'fechaInicio'}">Más próximos
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        <i class="bi bi-search me-2"></i>Buscar Grupos
                                    </button>
                                </div>
                            </form>
                            <div th:if="${error}" class="alert alert-danger text-center">
                                <span th:text="${error}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultados de búsqueda -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="fw-semibold mb-1">Resultados de búsqueda</h3>
                        <p class="text-muted" th:if="${grupos != null}">
                            Se encontraron <span th:text="${grupos.size()}">0</span> grupos que coinciden con tu
                            búsqueda
                        </p>
                    </div>
                    <!-- <div>
                        <select class="form-select" name="ordenar">
                            <option selected value="fecha">Ordenar por</option>
                            <option value="fecha">Fecha (más cercana)</option>
                            <option value="recientes">Más recientes</option>
                        </select>
                    </div> -->
                </div>

                <div class="row g-4">
                    <!-- Grupos de viaje -->
                    <div th:each="grupo : ${grupos}" class="col-md-6 col-lg-4">
                        <div class="card h-100 border-light hover-shadow">
                            <div class="position-relative">
                                <img th:if="${grupo.viaje != null && grupo.viaje.imagenDestacada != null}"
                                    th:src="${grupo.viaje.imagenDestacada}" class="card-img-top" alt="Imagen del viaje">
                                <img th:unless="${grupo.viaje != null && grupo.viaje.imagenDestacada != null}"
                                    th:src="@{/images/default-trip.jpg}" class="card-img-top" alt="Imagen por defecto">
                                <span class="badge bg-primary position-absolute top-0 start-0 m-2"
                                    th:if="${grupo.viaje != null && grupo.viaje.destinoPrincipal != null}">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    <span th:text="${grupo.viaje.destinoPrincipal}">Destino</span>
                                </span>
                                <span class="badge bg-success position-absolute top-0 end-0 m-2"
                                    th:if="${grupo.viaje != null && grupo.viaje.esVerificado}">
                                    <i class="bi bi-check-circle me-1"></i>Verificado
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title fw-bold" th:text="${grupo.nombreViaje}">Nombre del Viaje</h5>
                                </div>

                                <div class="d-flex align-items-center text-muted mb-2" th:if="${grupo.viaje != null}">
                                    <i class="bi bi-calendar me-2 text-primary"></i>
                                    <small>
                                        <span class="fw-medium">Inicio:</span>
                                        <span
                                            th:text="${#temporals.format(grupo.viaje.fechaInicio, 'dd MMM yyyy')}">Fecha
                                            Inicio</span> •
                                        <span class="fw-medium">Fin:</span>
                                        <span th:text="${#temporals.format(grupo.viaje.fechaFin, 'dd MMM yyyy')}">Fecha
                                            Fin</span>
                                    </small>
                                </div>

                                <div class="d-flex align-items-center text-muted mb-2">
                                    <i class="bi bi-people me-2 text-primary"></i>
                                    <small>
                                        <span class="fw-medium">Participantes:</span>
                                        <span th:text="${grupo.participantes.size() + 1}"></span> de <span
                                            th:text="${grupo.maxParticipantes}"></span>
                                        <span>•</span>
                                        <span class="fw-medium">Edad:</span>
                                        <span th:if="${grupo.viaje != null}">
                                            <span
                                                th:text="${grupo.viaje.rangoEdadMin != null ? grupo.viaje.rangoEdadMin : '18'}">18</span>-
                                            <span
                                                th:text="${grupo.viaje.rangoEdadMax != null ? grupo.viaje.rangoEdadMax : '60'}">60</span>
                                        </span>
                                        <span th:unless="${grupo.viaje != null}">Todas las edades</span>
                                    </small>
                                </div>

                                <p class="card-text text-muted small mb-3" th:if="${grupo.viaje != null}"
                                    th:text="${#strings.abbreviate(grupo.viaje.descripcion, 100)}">
                                    Descripción del viaje...
                                </p>

                                <div class="d-flex mb-3"
                                    >
                                    <div class="avatar-group">
                                        <div class="avatar-circle bg-primary text-white">
                                            <img th:if="${grupo.creador.fotoPerfil != null}"
                                                th:src="@{/uploads/{img}(img=${grupo.creador.fotoPerfil})}"
                                                alt="Imagen de perfil" />
                                            <div class="avatar-content" th:if="${grupo.creador.fotoPerfil == null}"
                                                th:text="${grupo.creador.iniciales}">OR</div>
                                        </div>
                                        <!-- Mostrar hasta 3 participantes más -->
                                        <th:block th:each="participante, iterStat : ${grupo.participantes}"
                                            th:if="${iterStat.index < 3 && participante.usuario != grupo.creador}">
                                            <div class="avatar-circle bg-light">
                                                <img th:if="${participante.usuario.fotoPerfil != null}"
                                                    th:src="@{/uploads/{img}(img=${participante.usuario.fotoPerfil})}"
                                                    alt="Imagen de perfil" />
                                                <div class="avatar-circle" th:if="${participante.usuario.fotoPerfil == null}"
                                                    th:text="${participante.usuario.iniciales}">XX</div>
                                            </div>
                                        </th:block>
                                        <!-- Mostrar +X si hay más participantes -->
                                        <div class="avatar-circle bg-primary-soft text-primary"
                                            th:if="${grupo.participantes.size() > 4}">
                                            <span th:text="${'+' + (grupo.participantes.size() - 4)}">+X</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex flex-wrap gap-1 mb-3"
                                    th:if="${grupo.etiquetas != null && !grupo.etiquetas.isEmpty()}">
                                    <span class="badge bg-light text-dark" th:each="etiqueta : ${grupo.etiquetas}"
                                        th:text="${etiqueta.nombreEtiqueta}">Etiqueta</span>
                                </div>



                                <a th:href="@{/grupos/{id}(id=${grupo.idGrupo})}" class="btn btn-primary w-100">
                                    Ver detalles <i class="bi bi-chevron-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensaje si no hay grupos -->
                <div th:if="${grupos == null || grupos.isEmpty()}" class="alert alert-info text-center my-5">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    No se encontraron grupos de viaje. ¡Crea uno nuevo!
                </div>

                <!-- Paginación -->
                <div class="d-flex justify-content-center mt-5" th:if="${totalPages > 1}">
                    <nav aria-label="Paginación de resultados">
                        <ul class="pagination">
                            <!--Botón anterior-->
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                <a class="page-link"
                                    th:href="@{/grupos(destinoPrincipal=${param.destinoPrincipal}, fechaInicio=${param.fechaInicio}, fechaFin=${param.fechaFin}, sort=${sort}, page=${currentPage - 1}, size=${size})}"
                                    aria-label="Anterior">
                                    <span aria-hidden="true"><i class="bi bi-chevron-left"></i></span>
                                </a>
                            </li>
                            <!--Números de paginas-->
                            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active'">
                                <a class="page-link"
                                    th:href="@{/grupos(destinoPrincipal=${param.destinoPrincipal}, fechaInicio=${param.fechaInicio}, fechaFin=${param.fechaFin}, sort=${sort}, page=${i}, size=${size})}"
                                    th:text="${i+1}">1</a>
                            </li>
                            <!--Botón siguiente-->
                            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                <a class="page-link"
                                    th:href="@{/grupos(destinoPrincipal=${param.destinoPrincipal}, fechaInicio=${param.fechaInicio}, fechaFin=${param.fechaFin}, sort=${sort}, page=${currentPage + 1}, size=${size})}"
                                    aria-label="Anterior">
                                    <span aria-hidden="true"><i class="bi bi-chevron-right"></i></span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Script para manejar las etiquetas -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tagInput = document.getElementById('tagInput');
            const addTagBtn = document.getElementById('addTagBtn');
            const tagContainer = document.getElementById('tagContainer');
            const etiquetasHidden = document.getElementById('etiquetasHidden');

            let tags = [];

            // Función para añadir etiqueta
            function addTag(tag) {
                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    updateTagsDisplay();
                    updateHiddenField();
                }
                tagInput.value = '';
            }

            // Función para eliminar etiqueta
            function removeTag(tag) {
                const index = tags.indexOf(tag);
                if (index !== -1) {
                    tags.splice(index, 1);
                    updateTagsDisplay();
                    updateHiddenField();
                }
            }

            // Actualizar la visualización de etiquetas
            function updateTagsDisplay() {
                tagContainer.innerHTML = '';
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'badge bg-light text-dark';
                    tagElement.innerHTML = `${tag} <i class="bi bi-x-circle" style="cursor: pointer;"></i>`;
                    tagElement.querySelector('i').addEventListener('click', function () {
                        removeTag(tag);
                    });
                    tagContainer.appendChild(tagElement);
                });
            }

            // Actualizar el campo oculto con las etiquetas
            function updateHiddenField() {
                etiquetasHidden.value = tags.join(',');
            }

            // Evento para añadir etiqueta
            addTagBtn.addEventListener('click', function () {
                const tag = tagInput.value.trim();
                if (tag) {
                    addTag(tag);
                }
            });

            // Evento para limpiar el campo de entrada
            tagInput.addEventListener('input', function () {
                if (tagInput.value.trim() === '') {
                    updateTagsDisplay();
                    updateHiddenField();
                }
            });

            // Mostrar mensaje de éxito si existe
            const urlParams = new URLSearchParams(window.location.search);
            const mensaje = urlParams.get('mensaje');
            const tipoMensaje = urlParams.get('tipoMensaje');

            if (mensaje && tipoMensaje === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: mensaje,
                    confirmButtonText: 'Genial',
                    timer: 3000,
                    timerProgressBar: true
                });
            }
        });
    </script>
</body>

</html>